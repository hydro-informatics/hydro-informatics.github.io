
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create a habitat suitability map &#8212; Hydro-Informatics</title>
    
  <link rel="stylesheet" href="../_static/css/index.f658d18f9b420779cfdf24aa0a7e2d77.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.40e2e510f6b7d1648584402491bb10fe.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.d3f166471bb80abb5163.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/tabs.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d31b09fe5c1d09cb49b26a786de4a05d.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe,.cell"
        const thebe_selector_input = "pre,.cell_input div.highlight"
        const thebe_selector_output = ".output,.cell_output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://hydro-informatics.github.io/exercises/ex-geco.html" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Principles" href="../numerics/numerical-modeling.html" />
    <link rel="prev" title="Exercises" href="geo-exercises.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />


<!-- Opengraph tags -->
<meta property="og:url"         content="https://hydro-informatics.github.io/exercises/ex-geco.html" />
<meta property="og:type"        content="article" />
<meta property="og:title"       content="Create a habitat suitability map" />
<meta property="og:description" content="Create a habitat suitability map  Goals  This exercise guides through the creation of rasters (osgeo.gdal.Dataset), the usage of georeferences, raster array cal" />
<meta property="og:image"       content="https://hydro-informatics.github.io/_static/icon.png" />

<meta name="twitter:card" content="summary" />


  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  <img src="../_static/icon.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">Hydro-Informatics</h1>
  
</a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../index.html">
   HOME
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Get Started
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../lectures/classroom.html">
   The Virtual Classroom
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../lectures/lectures.html">
     Lectures and exercises
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../lectures/take_seat.html">
     Take a Seat in the Virtual Classroom
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../get-started/software.html">
   Software Resources
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../get-started/vm.html">
     Virtual machines and Linux
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../get-started/ide.html">
     Anaconda and Integrated Development Environments (IDEs)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../get-started/git.html">
     Introduction to git
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../get-started/geo.html">
     Geospatial Software
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../get-started/install-openfoam.html">
     Install OpenFOAM
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../get-started/install-telemac.html">
     open TELEMAC (Installation)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../get-started/others.html">
     Other Software Resources
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Python Basics
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../python-basics/python.html">
   Get Started with Python
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../python-basics/pyinstall.html">
     Install Python
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../python-basics/pybase.html">
     First steps
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../python-basics/pyerror.html">
     Errors, Logging, and Debugging
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../python-basics/pyloop.html">
     Loops and Conditional Statements
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../python-basics/modularize.html">
   Modularization &amp; Object Orientation
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../python-basics/pyfun.html">
     Functions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../python-basics/pypckg.html">
     Packages, Modules and Libraries
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../python-basics/classes.html">
     Object Orientation and Classes
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../python-basics/data-handling.html">
   Data and File Handling
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../python-basics/pynum.html">
     Load and Write Basic Data Files
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../python-basics/pynum.html#numpy">
     NumPy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../python-basics/pynum.html#pandas">
     Pandas
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../python-basics/pynum.html#dates-and-time">
     Dates and Time
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../python-basics/xml.html">
     Manipulation of Workbooks and JSON Files
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../python-basics/pyplot.html">
     Plotting
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../python-basics/pystyle.html">
   Code Style and Conventions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../python-basics/gui.html">
   Graphical User Interfaces (GUIs)
  </a>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="python-exercises.html">
   Python Exercises
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="ex-ms.html">
     1d Hydraulics (Manning-Strickler Formula)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="ex-sp.html">
     Reservoir Volume Calculation with a Sequent Peak Algorithm
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="ex-floods.html">
     Calculate flood return periods
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="ex-sediment.html">
     One-dimensional (1d) Cross-section Averaged Sediment Transport
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="ex-gui.html">
     Create a
     <strong>
      G
     </strong>
     raphical
     <strong>
      U
     </strong>
     ser
     <strong>
      I
     </strong>
     nterface (GUI)
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Documentation
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../documentation/documentation.html">
   Markdown and Code Documentation
  </a>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="docs-exercises.html">
   Exercises
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="ex-git.html">
     Git and markdown
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Geospatial Analysis
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../geopy/geospatial-data.html">
   Geospatial Data
  </a>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../geopy/geo-python.html">
   Geospatial Python
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../geopy/geo-pckg.html">
     Geospatial Python - Open Source Packages
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../geopy/geo-shp.html">
     Shapefile (vector dataset) handling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../geopy/geo-raster.html">
     Raster (Gridded) Dataset Handling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../geopy/geo-convert.html">
     Raster to Vector Conversion and Vice Versa
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../geopy/geo-arcpy.html">
     The Commercial arcpy Library
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1 current active collapsible-parent">
  <a class="reference internal" href="geo-exercises.html">
   Exercises
  </a>
  <ul class="current collapse-ul">
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Create a habitat suitability map
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Numerical Modeling
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../numerics/numerical-modeling.html">
   Principles
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../numerics/pre-qgis.html">
   Pre-Processing with QGIS
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../numerics/basement.html">
   BASEMENT
  </a>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../numerics/telemac.html">
   TELEMAC
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../numerics/telemac2d.html">
     Pre-Processing for TELEMAC models
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../numerics/telemac3d.html">
     3d modeling with TELEMAC
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../numerics/telemac-gaia.html">
     Gaia Workflow
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../numerics/openfoam.html">
   OpenFOAM
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../numerics/calibration.html">
   Calibration and Valdiation
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Troubleshoot
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../troubleshoot/dbg-programming.html">
   Programming Tools and IDEs
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../troubleshoot/dbg-anaconda.html">
     Debugging Anaconda
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../troubleshoot/dbg-python.html">
     Debugging Python Code
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../troubleshoot/dbg-jupyter.html">
     Debugging Jupyter
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../troubleshoot/dbg-numerical-models.html">
   Numerical Models
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../troubleshoot/dbg-basement.html">
     Debugging BASEMENT
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../troubleshoot/dbg-telemac.html">
     Debugging TELEMAC/SALOME
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../troubleshoot/dbg-os.html">
   Operating Systems (Linux and VMs)
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../troubleshoot/dbg-linux.html">
     Debugging Debian Linux
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../troubleshoot/dbg-vm.html">
     Debugging Virtual Machines
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Disclaimer and License
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../terms/license.html">
   License
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../terms/disclaimer.html">
   Disclaimer
  </a>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Written by <a href="https://sebastian-schwindt.org">Sebastian Schwindt</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/exercises/ex-geco.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

        <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/hydro-informatics/hydro-informatics.github.io"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        
        
    </div>
</div>


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#what-is-habitat-suitability">
   What is Habitat Suitability?
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#available-data-and-code-structure">
   Available data and code structure
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#two-dimensional-2d-hydrodynamic-modelling-folder-basement-a-name-2dm-a">
     Two-dimensional (2D) hydrodynamic modelling (folder:
     <strong>
      basement
     </strong>
     )
     <a name="2dm">
     </a>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#habitat-suitability-index-hsi-curves-folder-habitat-a-name-hsi-curves-a">
     Habitat Suitability Index
     <em>
      HSI
     </em>
     curves (folder:
     <strong>
      habitat
     </strong>
     )
     <a name="hsi-curves">
     </a>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code">
     Code
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-and-combine-hsi-rasters">
   Create and combine
   <em>
    HSI
   </em>
   rasters
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#complete-magic-methods-of-the-raster-class-raster-py-a-name-raster-a">
     Complete magic methods of the
     <code class="docutils literal notranslate">
      <span class="pre">
       Raster
      </span>
     </code>
     class (
     <code class="docutils literal notranslate">
      <span class="pre">
       raster.py
      </span>
     </code>
     )
     <a name="raster">
     </a>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#write-hsi-and-chsi-raster-creation-script">
     Write
     <em>
      HSI
     </em>
     and
     <em>
      cHSI
     </em>
     raster creation script
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#run-the-hsi-and-chsi-raster-creation-code">
     Run the
     <em>
      HSI
     </em>
     and
     <em>
      cHSI
     </em>
     raster creation code
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#result-interpretation">
     Result interpretation
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#calculate-the-usable-habitat-area">
   Calculate the usable habitat area
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#write-the-code">
     Write the code
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#run-the-usable-habitat-area-calculation-code">
     Run the Usable Habitat Area calculation code
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Result interpretation
    </a>
   </li>
  </ul>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="create-a-habitat-suitability-map">
<h1>Create a habitat suitability map<a class="headerlink" href="#create-a-habitat-suitability-map" title="Permalink to this headline">¶</a></h1>
<div class="admonition-goals admonition">
<p class="admonition-title">Goals</p>
<p>This exercise guides through the creation of rasters (<code class="docutils literal notranslate"><span class="pre">osgeo.gdal.Dataset</span></code>), the usage of georeferences, raster array calculations, as well as the conversion of a raster to a polygon shapefile and modifications to the shapefile’s <em>Attribute Table</em> to calculate usable (physical) habitat area. For this purpose, a <code class="docutils literal notranslate"><span class="pre">Raster</span></code> class is written, which enables mathematical operations between its instances through the implementation of magic methods. The exercise also shows how the course’s <a class="reference external" href="https://github.com/hydro-informatics/geo-utils"><em>geo_utils</em> package</a> can be used to leverage complex challenges in just a few lines of code.</p>
</div>
<div class="admonition-requirements admonition">
<p class="admonition-title">Requirements</p>
<p><em>Python</em> libraries: <em>numpy</em>, <em>pandas</em>, <em>gdal</em>, <em>geopandas</em>, <em>alphashape</em>, <em>shapely</em>, and <em>json</em>. Understand how <a class="reference internal" href="../python-basics/classes.html"><span class="doc std std-doc">object orientation</span></a> works as well as <a class="reference internal" href="../geopy/geo-python.html"><span class="doc std std-doc">geospatial data and analyses with <em>Python</em></span></a>.</p>
</div>
<p>Get ready by cloning the exercise repository:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">Ecohydraulics</span><span class="o">/</span><span class="n">Exercise</span><span class="o">-</span><span class="n">geco</span><span class="o">.</span><span class="n">git</span>
</pre></div>
</div>
<div class="figure align-default" id="fish">
<img alt="fish Sacramento succer south yuba river" src="https://github.com/Ecohydraulics/media/raw/master/jpg/yuba-fish.jpg" />
<p class="caption"><span class="caption-number">Fig. 15 </span><span class="caption-text">Sacramento suckers in the South Yuba River (source: Sebastian Schwindt 2019).</span><a class="headerlink" href="#fish" title="Permalink to this image">¶</a></p>
</div>
<div class="section" id="what-is-habitat-suitability">
<h2>What is Habitat Suitability?<a class="headerlink" href="#what-is-habitat-suitability" title="Permalink to this headline">¶</a></h2>
<p>Fish and other aquatic species rest, orient, and reproduce in a fluvial environment that represents their physical habitat. Throughout their different life stages, different fish have specific physical habitat preferences which are defined, for instance, as a function of water depth, flow velocity, and grain size of the riverbed. The so-called <em>Habitat Suitability Index <strong>HSI</strong></em> can be calculated for hydraulic (water depth or flow velocity) and morphological (e.g., grain size or cover in the form of large wood) parameters individually to describe the quality of physical habitat for a fish and at a specific life stage. The figure below shows exemplary <em>HSI</em> curves for the fry, juvenile and adult life stages of rainbow trout as a function of water depth. The <em>HSI</em> curves look different in every river and should be established individually by an aquatic ecologist.
<a name="hsi-image"></a>
<img alt="hsi-curves" src="https://github.com/Ecohydraulics/media/raw/master/png/hsi-curves.png" /><br>
<em>Habitat Suitability Index (HSI) curves for the fry, juvenile, and adult life stages of rainbow trout in a cobble-bed river. Take care: HSI curves look different in any river and need to be established by an aquatic ecologist.</em></p>
<p>The <em>HSI</em> concept also accounts for the so-called cover habitat in the form of the <em>cover HSI</em> (<em>HSI<sub>cov</sub></em>). Cover habitat is the result of local turbulence caused by roughness elements such as wood, boulders, or bridge piers. However, in this exercise, we will only deal with hydraulic habitat characteristics (not cover habitat).</p>
<p><img alt="cover-habitat" src="https://github.com/Ecohydraulics/media/raw/master/jpg/neckar-fish-cover.jpg" /><br>
<em>Adult trout swimming in cover habitat created by a bridge pier in the upper Neckar River.</em></p>
<p>The combination of multiple <em>HSI</em> values (e.g., water depth-related <em>HSI<sub>h</sub></em>, flow velocity-related <em>HSI<sub>u</sub></em>, grain size-related <em>HSI<sub>d</sub></em>, and/or cover <em>HSI<sub>cov</sub></em>) results in the <em>combined Habitat Suitability Index <strong>cHSI</strong></em>. There are various calculation methods for combining different <em>HSI<sub>par</sub></em> values into one <em>cHSI</em> value, where the geometric mean and the product are the most widely used deterministic combination methods: <a name="combine-methods"></a></p>
<ul class="simple">
<li><p>Geometric mean:  <em>cHSI =</em> (<em>∏<sub>par</sub> HSI<sub>par</sub></em>)<em><sup>1/n</sup></em><br>For example, the combination of the water depth-related <em>HSI<sub>h</sub></em> and flow velocity-related <em>HSI<sub>u</sub></em> with the geometric mean method is: <em>cHSI = (HSI<sub>h</sub> · HSI<sub>u</sub>)<sup>1/2</sup></em></p></li>
<li><p>Product:  <em>cHSI = ∏<sub>par</sub> HSI<sub>par</sub></em><br>For example, the combination of the water depth-related <em>HSI<sub>h</sub></em> and flow velocity-related <em>HSI<sub>u</sub></em> with the product method is: <em>cHSI =</em> (<em>HSI<sub>h</sub> · HSI<sub>u</sub></em>)</p></li>
</ul>
<p>Therefore, if the pixel-based <em>HSI</em> values for water depth and flow velocity are known from a two-dimensional (2d) hydrodynamic model, then for each pixel the <em>cHSI</em> value can be calculated either as the product or geometric mean of the single-parameter <em>HSI<sub>par</sub></em> rasters.</p>
<p>This habitat assessment concept was introduced by <a class="reference external" href="https://pubs.er.usgs.gov/publication/70121265">Bovee (1986)</a> and <a class="reference external" href="https://apps.dtic.mil/sti/pdfs/ADA322762.pdf">Stalnaker (1995)</a>. However, these authors built their usable (physical) habitat assessment based on one-dimensional (1D) numerical models that were commonly used in the last millennium. Today, 2D numerical models are the state-of-the-art to determine physical habitat geospatially explicit based on pixel-based <em>cHSI</em> values. There are two different options for calculating the usable habitat area (<em>UHA</em>) based on pixel-based <em>cHSI</em> values (and even more options can be found in the scientific literature). <a name="uha-methods"></a></p>
<ol class="simple">
<li><p>Use a threshold value above which a pixel is classified as a usable habitat.</p>
<ul class="simple">
<li><p>Typical values for the threshold value <em>cHSI<sub>crit</sub></em> are between 0.4 (tolerant) and 0.75 (strict).</p></li>
<li><p>The usable habitat area <em>UHA</em> results from the pixel size <em>px<sub>a</sub></em> (e.g., in m²) multiplied by the number of pixels (<em>px</em>) where <em>cHSI &gt; cHSI<sub>crit</sub></em>:<br><em><strong>UHA = px<sub>a</sub> · ∑ px<sub>i</sub>(cHSI<sub>px<sub>i</sub></sub> &gt; cHSI<sub>crit</sub>)</strong></em></p></li>
</ul>
</li>
<li><p>Multiply the pixel <em>cHSI</em> value with the pixel size.</p>
<ul class="simple">
<li><p>The pixel area is weighted by its habitat quality expressed by the <em>cHSI</em> value:<br><em><strong>UHA = px<sub>a</sub> · ∑ cHSI<sub>px<sub>i</sub></sub></strong></em></p></li>
<li><p>Caution: Some authors (e.g., <a class="reference external" href="https://onlinelibrary.wiley.com/doi/full/10.1002/eco.1961">Yao et al. 2018</a>, <a class="reference external" href="https://doi.org/10.1007/s12205-012-0002-5">Tuhtan et al.</a> incorrectly refer to this weighting as Weighted Usable Area (<em>WUA</em>), which conflicts with the original definition of <em>WUA</em> (<a class="reference external" href="https://pubs.er.usgs.gov/publication/70121265">Bovee 1986</a>).</p></li>
</ul>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The threshold method is preferable over the weighting method because the <em>HSI</em>  has the unit of <em>Index</em> and is therefore not dimensionless. As a result, unrealistic units of <em>Index</em> areas (e.g., <em>Index</em>-m²) are created in the weighting method, which is also introducing non-measurable uncertainty.</p>
</div>
<p>An alternative to the deterministic calculation of the <em>HSI</em> and <em>cHSI</em> values of a pixel is a fuzzy logics approach (<a class="reference external" href="https://onlinelibrary.wiley.com/doi/pdf/10.1002/9781118526576">Noack et al. 2013</a>). In the fuzzy logic approach, pixels are classified, for instance, as <em>low</em>, <em>medium</em>, or <em>high</em> habitat quality as a function of the associated water depth or flow velocity using categorical (<em>low</em>, <em>medium</em>, or <em>high</em>), expert assessment-based <em>HSI</em> curves. The <em>cHSI</em> value results from the center of gravity of superimposed membership functions of considered parameters (e.g., water depth and flow velocity).</p>
<p>Sustainable river management involves the challenge of designing aquatic habitat for target fish species at different life stages. The concept of usable physical habitat area represents a powerful tool to leverage the assessment of the ecological integrity of river management and engineering measures. For example, by calculating the usable habitat area before and after the implementation of measures, valuable conclusions can be drawn about the ecological integrity of restoration efforts.</p>
<p>This exercise demonstrates the use of 2D hydrodynamic modeling results to algorithmically evaluate usable habitat area based on the calculation of geospatially explicit <em>cHSI</em> values.</p>
</div>
<div class="section" id="available-data-and-code-structure">
<h2>Available data and code structure<a class="headerlink" href="#available-data-and-code-structure" title="Permalink to this headline">¶</a></h2>
<p>The following flow chart illustrates the provided code and data. Functions, methods, and files to be created in this exercise are highlighted in bold, italic, <em>YELLOW</em> font.</p>
<p><a name="uml"></a>
<img alt="code-structure" src="https://github.com/Ecohydraulics/Exercise-geco/raw/master/graphs/geo_eco_uml.png" /><br></p>
<p>The provided <em>QGIS</em> project file <code class="docutils literal notranslate"><span class="pre">visualize_with_QGIS.qgz</span></code> helps to verify input raster datasets and results.</p>
<div class="section" id="two-dimensional-2d-hydrodynamic-modelling-folder-basement-a-name-2dm-a">
<h3>Two-dimensional (2D) hydrodynamic modelling (folder: <strong>basement</strong>) <a name="2dm"></a><a class="headerlink" href="#two-dimensional-2d-hydrodynamic-modelling-folder-basement-a-name-2dm-a" title="Permalink to this headline">¶</a></h3>
<p>This exercise uses (hydraulic) flow velocity and water depth rasters (<em>GeoTIFF</em>s) produced with the <a class="reference external" href="https://basement.ethz.ch/"><em>ETH Zurich</em>’s <em>BASEMENT</em></a> software. Read more about hydrodynamic modeling with <em>BASEMENT</em> on <a class="reference internal" href="../numerics/basement.html"><span class="doc std std-doc">hydro-informatics.github.io</span></a>. The hydraulic rasters were produced with the <em>BASEMENT</em> developer’s <a class="reference external" href="http://people.ee.ethz.ch/~basement/baseweb/download/tutorials/Flaz_2D_v3.zip">example data from the <em>Flaz River</em></a> in Switzerland (<a class="reference external" href="https://basement.ethz.ch/download/tutorials/tutorials3.html">read more on their website</a>).
The water depth <code class="docutils literal notranslate"><span class="pre">water_depth.tif</span></code> and flow velocity <code class="docutils literal notranslate"><span class="pre">flow_velocity.tif</span></code> rasters are provided for this exercise in the folder <code class="docutils literal notranslate"><span class="pre">/basement/</span></code>.</p>
</div>
<div class="section" id="habitat-suitability-index-hsi-curves-folder-habitat-a-name-hsi-curves-a">
<h3>Habitat Suitability Index <em>HSI</em> curves (folder: <strong>habitat</strong>) <a name="hsi-curves"></a><a class="headerlink" href="#habitat-suitability-index-hsi-curves-folder-habitat-a-name-hsi-curves-a" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">/habitat/</span></code> folder in the exercise repository contains <em>HSI</em> curves in the form of an <em>xlsx</em> workbook (<code class="docutils literal notranslate"><span class="pre">trout.xlsx</span></code>) and in the form of a <a class="reference external" href="python-basics/pyxml.html#json"><em>JSON</em> file</a> (<code class="docutils literal notranslate"><span class="pre">trout.json</span></code>). Both files contain the same data for rainbow trout of a hypothetical cobble-bed river and this exercise only uses the <em>JSON</em> file (the workbook serves for visual verification only).</p>
</div>
<div class="section" id="code">
<h3>Code<a class="headerlink" href="#code" title="Permalink to this headline">¶</a></h3>
<p><em><strong>GEO_UTILS (folder: geo_utils)</strong></em><br>
A couple of <code class="docutils literal notranslate"><span class="pre">gdal</span></code>-based functions for processing rasters and shapefiles were introduced in the lecture. This exercise re-uses some of these functions, which are available in the geo-processing code repository specifically for this course.
The name of this geoprocessing repository is <a class="reference external" href="https://github.com/hydro-informatics/geo-utils"><em>geo_utils</em></a>. Even though already provided in this exercise, make sure that the <em>geo_utils</em> repository is well implemented in the exercise directory (i.e., <em>geo_utils</em> scripts are stored in a folder tree like this: <code class="docutils literal notranslate"><span class="pre">Exercise-geco\geo_utils\</span></code>). The <code class="docutils literal notranslate"><span class="pre">\geo_utils\</span></code> folder corresponds to the <code class="docutils literal notranslate"><span class="pre">geo-utils\geo_utils\</span></code> directory when you clone the repository.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Make sure that in the <code class="docutils literal notranslate"><span class="pre">\geo_utils\geoconfig.py</span></code> file, the <code class="docutils literal notranslate"><span class="pre">nan_value</span></code> is defined as 0.0 (<code class="docutils literal notranslate"><span class="pre">nan_value</span> <span class="pre">=</span> <span class="pre">0.0</span></code>).</p>
</div>
<p><em><strong><a class="reference external" href="http://CONFIG.PY">CONFIG.PY</a></strong></em><br>
The code in this exercise uses a <code class="docutils literal notranslate"><span class="pre">config.py</span></code> file where all necessary libraries and global variables are loaded centrally.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># This is config.py</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">geo_utils</span> <span class="k">as</span> <span class="nn">geo</span>

<span class="n">cache_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">__cache__</span><span class="se">\\</span><span class="s2">&quot;</span>
<span class="n">par_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;velocity&quot;</span><span class="p">:</span> <span class="s2">&quot;u&quot;</span><span class="p">,</span>
            <span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="s2">&quot;h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;grain_size&quot;</span><span class="p">:</span> <span class="s2">&quot;d&quot;</span><span class="p">}</span>
<span class="n">nan_value</span> <span class="o">=</span> <span class="mf">0.0</span>
</pre></div>
</div>
<p><em><strong><a class="reference external" href="http://FUN.PY">FUN.PY</a> (FUNCTIONS)</strong></em><br>
At this point in the course, it is assumed that students are familiar with object orientation and especially with writing functions. Therefore, many basic functions for this exercise are already provided with the script <code class="docutils literal notranslate"><span class="pre">fun.py</span></code> (alphabetically ordered list):
<a name="funs"></a></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cache</span></code> is a wrapper for parent functions to enforce that intermediate geospatial datasets (e.g., the intermediate product of a sum of rasters) are stored in a temporary <em>cache</em> folder that is deleted after the script ran.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">check_cache</span></code> verifies if the cache folder defined in <code class="docutils literal notranslate"><span class="pre">config.py</span></code> already exists. The function is automatically called by the <code class="docutils literal notranslate"><span class="pre">cache</span></code> wrapper.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">create_random_string(length)</span></code> generates unique file names for temporary (cached) datasets, where <code class="docutils literal notranslate"><span class="pre">length</span></code> is an <em>integer</em> value that determines the number of characters of the random string to be created.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">interpolate_from_list(x_values,</span> <span class="pre">y_values,</span> <span class="pre">xi_values)</span></code> linearly interpolates <em>y<sub>i</sub></em> values from two sorted lists containing paired <em>x</em> and <em>y</em> values for a <em>list</em> of given <em>x<sub>i</sub></em> values (returns a <code class="docutils literal notranslate"><span class="pre">numpy.array</span></code> of the same length as <code class="docutils literal notranslate"><span class="pre">xi_values</span></code>). If one of the <em>x<sub>i</sub></em> values is beyond the value range of <code class="docutils literal notranslate"><span class="pre">x_values</span></code>, the function appends the <code class="docutils literal notranslate"><span class="pre">nan_value</span></code> defined in <code class="docutils literal notranslate"><span class="pre">config.py</span></code> to the results array.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">interpolate_y(x1,</span> <span class="pre">x2,</span> <span class="pre">y1,</span> <span class="pre">y2,</span> <span class="pre">xi)</span></code> is called by the <code class="docutils literal notranslate"><span class="pre">interpolate_from_list</span></code> function for paired lower and upper <code class="docutils literal notranslate"><span class="pre">x1</span></code>-<code class="docutils literal notranslate"><span class="pre">y1</span></code> and <code class="docutils literal notranslate"><span class="pre">x2</span></code>-<code class="docutils literal notranslate"><span class="pre">y2</span></code> <em>float</em>s of the <code class="docutils literal notranslate"><span class="pre">x_values</span></code> and <code class="docutils literal notranslate"><span class="pre">y_values</span></code> <em>list</em>s (returns a <em>float</em> number corresponding to the linearly interpolated <code class="docutils literal notranslate"><span class="pre">yi</span></code> value of the <code class="docutils literal notranslate"><span class="pre">xi</span></code>-<code class="docutils literal notranslate"><span class="pre">yi</span></code> pair between <code class="docutils literal notranslate"><span class="pre">x1</span></code>-<code class="docutils literal notranslate"><span class="pre">y1</span></code> and <code class="docutils literal notranslate"><span class="pre">x2</span></code>-<code class="docutils literal notranslate"><span class="pre">y2</span></code>). If <code class="docutils literal notranslate"><span class="pre">xi</span></code> is not numeric, or if the interpolation results in a <code class="docutils literal notranslate"><span class="pre">ZeroDivisionError</span></code>, the function returns the <code class="docutils literal notranslate"><span class="pre">nan_value</span></code> defined in <code class="docutils literal notranslate"><span class="pre">config.py</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">log_actions(fun)</span></code> wraps a function (<code class="docutils literal notranslate"><span class="pre">fun</span></code>), where actions should be written to a logfile. Logging is started with the <code class="docutils literal notranslate"><span class="pre">start_logging</span></code> function (see below) and logging is stopped with <code class="docutils literal notranslate"><span class="pre">logging.shutdown()</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">read_json</span></code> opens a <em>JSON</em> file and returns it as <em>Python</em> object. In this exercise, this function will be used to open the <code class="docutils literal notranslate"><span class="pre">/habitat/trout.json</span></code> file. The <em>HSI</em> values can then be assessed from the <em>JSON</em> object, for example:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">trout</span> <span class="o">=</span> <span class="n">read_json</span><span class="p">(</span><span class="s2">&quot;PATH/&quot;</span> <span class="o">+</span> <span class="s2">&quot;trout.json&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">trout</span><span class="p">[</span><span class="s2">&quot;velocity&quot;</span><span class="p">][</span><span class="s2">&quot;spawning&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;u&quot;</span><span class="p">])</span>

<span class="o">&gt;&gt;&gt;</span> <span class="mf">0.0198</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">remove_directory(directory)</span></code> removes a <code class="docutils literal notranslate"><span class="pre">directory</span></code> (<em>string</em> argument). Be careful, this function aggressively removes the <code class="docutils literal notranslate"><span class="pre">directory</span></code> and all its contents with little chance of data recovery.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">start_logging()</span></code> starts logging to a logfile (<code class="docutils literal notranslate"><span class="pre">logfile.log</span></code>) and the <em>Python</em> console at the <code class="docutils literal notranslate"><span class="pre">logging.DEBUG</span></code> level.</p></li>
</ul>
<p><em><strong><a class="reference external" href="http://RASTER.PY">RASTER.PY</a> / RASTER_HSI.PY</strong></em><br>
The parent <code class="docutils literal notranslate"><span class="pre">Raster</span></code> class is stored in the <code class="docutils literal notranslate"><span class="pre">raster.py</span></code> script, where magic methods, a <em>pseudo</em> private <code class="docutils literal notranslate"><span class="pre">_make_raster</span></code>, and a <code class="docutils literal notranslate"><span class="pre">save</span></code> method will be created in this exercise.
The <code class="docutils literal notranslate"><span class="pre">HSIRaster</span></code> class in the <code class="docutils literal notranslate"><span class="pre">raster_hsi.py</span></code> script is a child of the <code class="docutils literal notranslate"><span class="pre">Raster</span></code> class. In this exercise, we will only look at how this child class is structured and what it produces (i.e., no modifications are necessary).</p>
<p><em><strong>CREATE_HSI_RASTERS.PY and CALCULATE_HABITAT_AREA.PY</strong></em><br>
The two scripts <code class="docutils literal notranslate"><span class="pre">reate_hsi_rasters.py</span></code> and <code class="docutils literal notranslate"><span class="pre">calculate_habitat_area.py</span></code> represent the focal point of this exercise and make use of the provided data and <em>Python</em> scripts. Therefore, only the basic framework functions and imports are pre-existing in these two template scripts.</p>
</div>
</div>
<div class="section" id="create-and-combine-hsi-rasters">
<h2>Create and combine <em>HSI</em> rasters<a class="headerlink" href="#create-and-combine-hsi-rasters" title="Permalink to this headline">¶</a></h2>
<div class="section" id="complete-magic-methods-of-the-raster-class-raster-py-a-name-raster-a">
<h3>Complete magic methods of the <code class="docutils literal notranslate"><span class="pre">Raster</span></code> class (<code class="docutils literal notranslate"><span class="pre">raster.py</span></code>)<a name="raster"></a><a class="headerlink" href="#complete-magic-methods-of-the-raster-class-raster-py-a-name-raster-a" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">raster.py</span></code> script imports the functions and libraries loaded in the <code class="docutils literal notranslate"><span class="pre">fun.py</span></code> script, and therefore, also the <code class="docutils literal notranslate"><span class="pre">config.py</span></code> script. For this reason, the <em>numpy</em> and <em>pandas</em> libraries are already available (<code class="docutils literal notranslate"><span class="pre">as</span></code> <code class="docutils literal notranslate"><span class="pre">np</span></code> and <code class="docutils literal notranslate"><span class="pre">pd</span></code>, respectively), and the <em>geo_utils</em> package is already imported as <code class="docutils literal notranslate"><span class="pre">geo</span></code> (<code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">geo_utils</span> <span class="pre">as</span> <span class="pre">geo</span></code> in <code class="docutils literal notranslate"><span class="pre">config.py</span></code>).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Raster</span></code> class will load any <em>GeoTIFF</em> file name as a geo-referenced array object that can be used with mathematical operators. First, we will complement the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method by a <code class="docutils literal notranslate"><span class="pre">Raster.name</span></code> (extract from the <code class="docutils literal notranslate"><span class="pre">file_name</span></code> argument), as well as georeferences and array datasets:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="c1"># __init__(...) of Raster class in raster.py</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>If the provided <code class="docutils literal notranslate"><span class="pre">file_name</span></code> does not exist, the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method creates a new raster with the <code class="docutils literal notranslate"><span class="pre">file_name</span></code> (this behaviour is already implemented in the <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">not</span> <span class="pre">os.path.exists(file_name)</span></code> statement.
Next, load the <code class="docutils literal notranslate"><span class="pre">osgeo.gdal.dataset</span></code>, the <code class="docutils literal notranslate"><span class="pre">np.array</span></code>, and the <code class="docutils literal notranslate"><span class="pre">geo_transformation</span></code> of the raster. For this purpose, use the <a class="reference external" href="geopy/geo-raster.html#createarray"><em>raster2array</em> function</a> from the lecture, which is also implemented in <em>geo_utils</em> (<code class="docutils literal notranslate"><span class="pre">geo</span></code>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="c1"># __init__(...) of Raster class in raster.py</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo_transformation</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">raster2array</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">band_number</span><span class="o">=</span><span class="n">band</span><span class="p">)</span>
</pre></div>
</div>
<p>To identify the <a class="reference external" href="geopy/geospatial-data.html#prj"><em>EPSG</em> number (Authority code)</a> of a raster, retrieve the spatial reference system (<em>SRS</em>) of the raster. Also for this purpose we have already developed a function in the lecture with the <a class="reference external" href="geopy/geo-raster.html#reproject"><em>get_srs</em> function</a>. Load the <em>SRS</em> and the <em>EPSG</em> number using the <em>get_srs</em> function with the following two lines of code in the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="c1"># __init__(...) of Raster class in raster.py</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">srs</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">get_srs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srs</span><span class="o">.</span><span class="n">GetAuthorityCode</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>That is it. The <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method of the <code class="docutils literal notranslate"><span class="pre">Raster</span></code> class is complete.</p>
<hr class="docutils" />
<p>To enable mathematical operations between multiple instances of the <code class="docutils literal notranslate"><span class="pre">Raster</span></code> class, implement <a class="reference external" href="python-basics/pyclasses.html#operator-binary-and-assignment-methods">magic methods (recall the lecture notes)</a> that tell the class what to do when two <code class="docutils literal notranslate"><span class="pre">Raster</span></code> instances are for example added (<code class="docutils literal notranslate"><span class="pre">+</span></code> sign), multiplied (<code class="docutils literal notranslate"><span class="pre">*</span></code> sign), or subtracted (<code class="docutils literal notranslate"><span class="pre">-</span></code> sign). For instance, implementing the magic methods <code class="docutils literal notranslate"><span class="pre">__truediv__</span></code> (for using the <code class="docutils literal notranslate"><span class="pre">/</span></code> operator), <code class="docutils literal notranslate"><span class="pre">__mul__</span></code> (for using the <code class="docutils literal notranslate"><span class="pre">*</span></code> operator), and <code class="docutils literal notranslate"><span class="pre">__pow__</span></code> (for using the <code class="docutils literal notranslate"><span class="pre">**</span></code> operator) will enable the usage of <code class="docutils literal notranslate"><span class="pre">Raster</span></code> instances like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># example for Raster instances, when operators are defined through magic methods</span>

<span class="c1"># load GeoTIFF rasters from file directory</span>
<span class="n">velocity</span> <span class="o">=</span> <span class="n">Raster</span><span class="p">(</span><span class="s2">&quot;/usr/geodata/u.tif&quot;</span><span class="p">)</span>
<span class="n">depth</span> <span class="o">=</span> <span class="n">Raster</span><span class="p">(</span><span class="s2">&quot;/usr/geodata/h.tif&quot;</span><span class="p">)</span>

<span class="c1"># calculate the Froude number using operators defined with magic methods</span>
<span class="n">Froude</span> <span class="o">=</span> <span class="n">velocity</span> <span class="o">/</span> <span class="p">(</span><span class="n">depth</span> <span class="o">*</span> <span class="mf">9.81</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>

<span class="c1"># save the new raster</span>
<span class="n">Froude</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;/usr/geodata/froude.tif&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Raster</span></code> class template already contains one exemplary magic method to enable division (<code class="docutils literal notranslate"><span class="pre">__truediv__</span></code>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="c1"># Raster class in raster.py</span>
    <span class="k">def</span> <span class="fm">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constant_or_raster</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">constant_or_raster</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">/=</span> <span class="n">constant_or_raster</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_raster</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Let us take a close look at what the <code class="docutils literal notranslate"><span class="pre">__truediv__</span></code> method does:</p>
<ul class="simple">
<li><p>The input argument <code class="docutils literal notranslate"><span class="pre">constant_or_raster</span></code> can be another <code class="docutils literal notranslate"><span class="pre">Raster</span></code> instance that has an <code class="docutils literal notranslate"><span class="pre">array</span></code> attribute or a numeric constant (e.g., 9.81).</p></li>
<li><p>The method tries to invoke the array attribute of <code class="docutils literal notranslate"><span class="pre">constant_or_raster</span></code>.</p>
<ul>
<li><p>If <code class="docutils literal notranslate"><span class="pre">constant_or_raster</span></code> is a raster object, then invoking <code class="docutils literal notranslate"><span class="pre">contant_or_raster.array</span></code> is successful. In this case <code class="docutils literal notranslate"><span class="pre">self.array</span></code> is overwritten with the element-wise division of the array by <code class="docutils literal notranslate"><span class="pre">contant_or_raster.array</span></code>. The element-wise division builds on <em>numpy</em>’s built-in function <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.divide.html"><em>np.divide</em></a>, which is a computationally efficient wrapper of C/C++ code (much faster than a <em>Python</em> loop over array elements).</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">constant_or_raster</span></code> is a numeric value, then invoking <code class="docutils literal notranslate"><span class="pre">contant_or_raster.array</span></code> results in an <code class="docutils literal notranslate"><span class="pre">AttributeError</span></code> and the <code class="docutils literal notranslate"><span class="pre">__truediv__</span></code> method falls in the <code class="docutils literal notranslate"><span class="pre">except</span> <span class="pre">AttributeError</span></code> statement, where <code class="docutils literal notranslate"><span class="pre">self.array</span></code> is simply divided by <code class="docutils literal notranslate"><span class="pre">constant_or_raster</span></code>.</p></li>
</ul>
</li>
<li><p>The method returns the result of the pseudo private method <code class="docutils literal notranslate"><span class="pre">self._make_raster(&quot;div&quot;)</span></code> (<a class="reference external" href="python-basics/pypystyle.html#name-conventions">recall <em>PEP 8</em> code style conventions on <code class="docutils literal notranslate"><span class="pre">_single_leading_underscore</span></code> methods</a>, which corresponds to a new <code class="docutils literal notranslate"><span class="pre">Raster</span></code> instance of the actual <code class="docutils literal notranslate"><span class="pre">Raster</span></code> instance divided by <code class="docutils literal notranslate"><span class="pre">constant_or_raster</span></code>. The new <code class="docutils literal notranslate"><span class="pre">Raster</span></code> instance is a temporary <em>GeoTIFF</em>  file in the <em>cache</em> folder (<a class="reference external" href="#funs">recall the cache function</a>). This is how the pseudo-private method <code class="docutils literal notranslate"><span class="pre">_make_raster(self,</span> <span class="pre">file_marker)</span></code> looks like:<a name="make-raster"></a></p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">_make_raster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_marker</span><span class="p">):</span>
        <span class="n">f_ending</span> <span class="o">=</span> <span class="s2">&quot;__</span><span class="si">{0}{1}</span><span class="s2">__.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_marker</span><span class="p">,</span> <span class="n">create_random_string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">geo</span><span class="o">.</span><span class="n">create_raster</span><span class="p">(</span><span class="n">cache_folder</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="n">f_ending</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">epsg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epsg</span><span class="p">,</span>
                          <span class="n">nan_val</span><span class="o">=</span><span class="n">nan_value</span><span class="p">,</span>
                          <span class="n">geo_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geo_transformation</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Raster</span><span class="p">(</span><span class="n">cache_folder</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="n">f_ending</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">file_marker</span></code> is a <em>string</em> variable added to the <em>GeoTIFF</em> file name along with a random, four characters-long <em>string</em> (<a class="reference external" href="#funs">recall the <code class="docutils literal notranslate"><span class="pre">create_random_string</span></code> function</a>). <code class="docutils literal notranslate"><span class="pre">file_marker</span></code> is unique for every implemented operator. For the <code class="docutils literal notranslate"><span class="pre">__truediv__</span></code> method use <code class="docutils literal notranslate"><span class="pre">file_marker=&quot;div&quot;</span></code>. Thus, the temporary <em>GeoTIFF</em> file name is defined as <code class="docutils literal notranslate"><span class="pre">cache_folder</span> <span class="pre">+</span> <span class="pre">self.name</span> <span class="pre">+</span> <span class="pre">f_ending</span></code> (e.g. <code class="docutils literal notranslate"><span class="pre">&quot;C:\Excercise-geco\__cache__\velocity__divhjev__.tif&quot;</span></code>).</p></li>
<li><p>From <code class="docutils literal notranslate"><span class="pre">geo_utils</span></code>, the <a class="reference external" href="geopy/geo-raster.html#create"><code class="docutils literal notranslate"><span class="pre">create_raster</span></code></a> function is used to actually write the temporary <em>GeoTIFF</em> to the <code class="docutils literal notranslate"><span class="pre">__cache__</span></code> folder using the original raster’s spatial reference system.</p></li>
<li><p>The method <code class="docutils literal notranslate"><span class="pre">return</span></code>s a new <code class="docutils literal notranslate"><span class="pre">Raster</span></code> instance of the temporary, cached <em>GeoTIFF</em> file.</p></li>
</ul>
<hr class="docutils" />
<blockquote>
<div><p><em><strong>Digression: If you think the <code class="docutils literal notranslate"><span class="pre">_make_raster</span></code> method is confusing …</strong></em></p>
</div></blockquote>
<p>Then you have a point. The above-described approach implements the <code class="docutils literal notranslate"><span class="pre">_make_raster</span></code> method to reuse the temporary <em>GeoTIFF</em>s later with both constants (<em>float</em>) and arrays, but there is a more elegant way to return a new <code class="docutils literal notranslate"><span class="pre">Raster</span></code> instance. However, returning a new instance of the same class requires that the input argument must be an instance of the class itself (i.e., <code class="docutils literal notranslate"><span class="pre">Raster</span></code>) and not a numeric variable. The alternative solution for returning a <code class="docutils literal notranslate"><span class="pre">Raster</span></code> instance starts with a different implementation of the magic method (e.g., <code class="docutils literal notranslate"><span class="pre">__truediv__</span></code>) and requires to import <em>Python4</em>-style <code class="docutils literal notranslate"><span class="pre">annotations</span></code>. Therefore, the first line of the script must include (only works with <em>Python 3.7</em> and higher) the following import:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
</pre></div>
</div>
<p>Then we can rewrite the <code class="docutils literal notranslate"><span class="pre">__truediv__</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="fm">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Raster</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Raster</span><span class="p">:</span>
        <span class="n">f_ending</span> <span class="o">=</span> <span class="s2">&quot;__div</span><span class="si">%s</span><span class="s2">__.tif&quot;</span> <span class="o">%</span> <span class="n">create_random_string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Raster</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="n">cache_folder</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="n">f_ending</span><span class="p">,</span>
                      <span class="n">raster_array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">array</span><span class="p">),</span>
                      <span class="n">epsg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epsg</span><span class="p">,</span>
                      <span class="n">geo_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geo_transformation</span><span class="p">)</span>
</pre></div>
</div>
<p>In this case, the <code class="docutils literal notranslate"><span class="pre">_make_raster</span></code> method is obsolete. Read more about returning instances of the same class on <a class="reference external" href="https://stackoverflow.com/questions/33533148/how-do-i-specify-that-the-return-type-of-a-method-is-the-same-as-the-class-itsel">stack overflow</a>.</p>
<hr class="docutils" />
<p><em><strong>Back to the exercise using the <code class="docutils literal notranslate"><span class="pre">_make_raster</span></code> method.</strong></em> Add the following magic methods to the <code class="docutils literal notranslate"><span class="pre">Raster</span></code> class (function placeholders are already present in the  <code class="docutils literal notranslate"><span class="pre">raster.py</span></code> template):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">__add__</span></code> (<code class="docutils literal notranslate"><span class="pre">+</span></code> operator):</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">+=</span> <span class="n">constant_or_raster</span><span class="o">.</span><span class="n">array</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">+=</span> <span class="n">constant_or_raster</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_raster</span><span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">__mul__</span></code> (<code class="docutils literal notranslate"><span class="pre">*</span></code> operator):</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">constant_or_raster</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">*=</span> <span class="n">constant_or_raster</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_raster</span><span class="p">(</span><span class="s2">&quot;mul&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">__pow__</span></code> (<code class="docutils literal notranslate"><span class="pre">**</span></code> operator):</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">constant_or_raster</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">**=</span> <span class="n">constant_or_raster</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_raster</span><span class="p">(</span><span class="s2">&quot;pow&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">__sub__</span></code> (<code class="docutils literal notranslate"><span class="pre">-</span></code> operator):</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">-=</span> <span class="n">constant_or_raster</span><span class="o">.</span><span class="n">array</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">-=</span> <span class="n">constant_or_raster</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_raster</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The last item to complete in the <code class="docutils literal notranslate"><span class="pre">Raster</span></code> class is the built-in <code class="docutils literal notranslate"><span class="pre">save</span></code> method that receives a <code class="docutils literal notranslate"><span class="pre">file_name</span></code> (<em>string</em>) argument defining the directory and save-as name of the <code class="docutils literal notranslate"><span class="pre">Raster</span></code> instance:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>        <span class="n">save_status</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">create_raster</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">epsg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epsg</span><span class="p">,</span> <span class="n">nan_val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">geo_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geo_transformation</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">save_status</span>
</pre></div>
</div>
<p>Why do we need the <code class="docutils literal notranslate"><span class="pre">save_status</span></code> variable? First, it states if saving the raster was successful (<code class="docutils literal notranslate"><span class="pre">save_status=0</span></code>), and second, this information could be used to delete the raster from the <code class="docutils literal notranslate"><span class="pre">__cache__</span></code> folder and flush the memory (feel free to do so for speeding up the code).</p>
</div>
<hr class="docutils" />
<div class="section" id="write-hsi-and-chsi-raster-creation-script">
<h3>Write <em>HSI</em> and <em>cHSI</em> raster creation script<a class="headerlink" href="#write-hsi-and-chsi-raster-creation-script" title="Permalink to this headline">¶</a></h3>
<p>The provided <code class="docutils literal notranslate"><span class="pre">create_hsi_rasters.py</span></code> script already contains required package imports, an <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">__name__</span> <span class="pre">==</span> <span class="pre">'__main__'</span></code> stand-alone statement as well as the void <code class="docutils literal notranslate"><span class="pre">main</span></code>, <code class="docutils literal notranslate"><span class="pre">get_hsi_curve</span></code>, <code class="docutils literal notranslate"><span class="pre">get_hsi_raster</span></code>, and <code class="docutils literal notranslate"><span class="pre">combine_hsi_rasters</span></code> functions:<a name="chsi-template"></a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># create_hsi_rasters.py</span>
<span class="kn">from</span> <span class="nn">fun</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">raster_hsi</span> <span class="kn">import</span> <span class="n">HSIRaster</span><span class="p">,</span> <span class="n">Raster</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">perf_counter</span>

<span class="k">def</span> <span class="nf">combine_hsi_rasters</span><span class="p">(</span><span class="n">raster_list</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;geometric_mean&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">get_hsi_curve</span><span class="p">(</span><span class="n">json_file</span><span class="p">,</span> <span class="n">life_stage</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">get_hsi_raster</span><span class="p">(</span><span class="n">tif_dir</span><span class="p">,</span> <span class="n">hsi_curve</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">pass</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># define global variables for the main() function</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;velocity&quot;</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">]</span>
    <span class="n">life_stage</span> <span class="o">=</span> <span class="s2">&quot;juvenile&quot;</span>
    <span class="n">fish_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">habitat</span><span class="se">\\</span><span class="s2">trout.json&quot;</span>
    <span class="n">tifs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;velocity&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">basement</span><span class="se">\\</span><span class="s2">flow_velocity.tif&quot;</span><span class="p">,</span>
            <span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">basement</span><span class="se">\\</span><span class="s2">water_depth.tif&quot;</span><span class="p">}</span>
    <span class="n">hsi_output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">habitat</span><span class="se">\\</span><span class="s2">&quot;</span>

    <span class="c1"># run code and evaluate performance</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">main</span><span class="p">()</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time elapsed: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span>

</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">__name__</span> <span class="pre">==</span> <span class="pre">'__main__'</span></code> statement contains a time counter (<code class="docutils literal notranslate"><span class="pre">perf_counter</span></code>) that prompts how long running the script takes (typically between 3 to 6 seconds). Make sure that</p>
<ul class="simple">
<li><p>the <code class="docutils literal notranslate"><span class="pre">parameters</span></code> list contains <code class="docutils literal notranslate"><span class="pre">&quot;velocity&quot;</span></code> and <code class="docutils literal notranslate"><span class="pre">&quot;depth&quot;</span></code> (as per the <code class="docutils literal notranslate"><span class="pre">par_dict</span></code> in the <code class="docutils literal notranslate"><span class="pre">config.py</span></code> script),</p></li>
<li><p>the file paths are defined correctly, and</p></li>
<li><p>a life stage is defined (i.e., either <code class="docutils literal notranslate"><span class="pre">&quot;fry&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;juvenile&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;adult&quot;</span></code>, or <code class="docutils literal notranslate"><span class="pre">&quot;spawning&quot;</span></code> as per the <em>/habitat/fish.xlsx</em>  workbook).</p></li>
</ul>
<p>The following paragraphs show step by step how to load the <em>HSI</em> curves from the <em>JSON</em> file (<code class="docutils literal notranslate"><span class="pre">get_hsi_curve</span></code>), apply them to the <code class="docutils literal notranslate"><span class="pre">flow_velocity</span></code> and <code class="docutils literal notranslate"><span class="pre">water_depth</span></code> rasters (<code class="docutils literal notranslate"><span class="pre">get_hsi_raster</span></code>), and combine the resulting <em>HSI</em> rasters into <em>cHSI</em> rasters (<code class="docutils literal notranslate"><span class="pre">combine_hsi_rasters</span></code>).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">get_hsi_curve</span></code> function will load the <em>HSI</em> curve from the <em>JSON</em> file (<em>/habitat/trout.json</em>) in a dictionary for the two parameters <code class="docutils literal notranslate"><span class="pre">&quot;velocity&quot;</span></code> and <code class="docutils literal notranslate"><span class="pre">&quot;depth&quot;</span></code>. Thus, the goal is to create a <code class="docutils literal notranslate"><span class="pre">curve_data</span></code> dictionary that contains one <em>pandas</em> <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> object for all parameters (i.e., velocity and depth). For example, <code class="docutils literal notranslate"><span class="pre">curve_data[&quot;velocity&quot;][&quot;u&quot;]</span></code> will be a <em>pandas</em> <code class="docutils literal notranslate"><span class="pre">Series</span></code> of velocity entries (in m/s) that corresponds to <code class="docutils literal notranslate"><span class="pre">curve_data[&quot;velocity&quot;][&quot;HSI&quot;]</span></code>, which is a <em>pandas</em> <code class="docutils literal notranslate"><span class="pre">Series</span></code> of <em>HSI</em> values. Similarly, <code class="docutils literal notranslate"><span class="pre">curve_data[&quot;depth&quot;][&quot;h&quot;]</span></code> is a <em>pandas</em> <code class="docutils literal notranslate"><span class="pre">Series</span></code> of depth entries (in meters) that corresponds to <code class="docutils literal notranslate"><span class="pre">curve_data[&quot;depth&quot;][&quot;HSI&quot;]</span></code>, which is a <em>pandas</em> <code class="docutils literal notranslate"><span class="pre">Series</span></code> of <em>HSI</em> values (corresponds to the curves shown in the <a class="reference external" href="#hsi-image"><em>HSI</em> graphs</a> above). To extract the desired information from the <em>JSON</em> file, <code class="docutils literal notranslate"><span class="pre">get_hsi_curve</span></code> takes three arguments (<code class="docutils literal notranslate"><span class="pre">json_file</span></code>, <code class="docutils literal notranslate"><span class="pre">life_stage</span></code>, and <code class="docutils literal notranslate"><span class="pre">parameters</span></code>) in order to:</p>
<ul class="simple">
<li><p>Get the information stored in the <em>JSON</em> file with the <code class="docutils literal notranslate"><span class="pre">read_json</span></code> function (<a class="reference external" href="#funs">see above</a>).</p></li>
<li><p>Instantiate a void <code class="docutils literal notranslate"><span class="pre">curve_data</span></code> <em>dictionary</em> that will contain the <em>pandas</em> <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>s for <code class="docutils literal notranslate"><span class="pre">&quot;velocity&quot;</span></code> and <code class="docutils literal notranslate"><span class="pre">&quot;depth&quot;</span></code>.</p></li>
<li><p>Run a loop over the (two) parameters (<code class="docutils literal notranslate"><span class="pre">&quot;velocity&quot;</span></code> and <code class="docutils literal notranslate"><span class="pre">&quot;depth&quot;</span></code>), in which it:</p>
<ul>
<li><p>Creates a void <code class="docutils literal notranslate"><span class="pre">par_pairs</span></code> <em>list</em> for storing pairs of parameter (<code class="docutils literal notranslate"><span class="pre">par</span></code>) - * HSI* values as nested lists.</p></li>
<li><p>Iterates through the length of provided curve data, where valid data pairs (e.g., <code class="docutils literal notranslate"><span class="pre">[u_value,</span> <span class="pre">HSI_value]</span></code>) are appended to the <code class="docutils literal notranslate"><span class="pre">par_pairs</span></code> <em>list</em>. This iteration is what actually creates the nested <em>list</em>.</p></li>
<li><p>Converts the final <code class="docutils literal notranslate"><span class="pre">par_pairs</span></code> list to a <em>pandas</em> <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> that it adds to the <code class="docutils literal notranslate"><span class="pre">curve_data</span></code> <em>dictionary</em>.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">return</span></code> the <code class="docutils literal notranslate"><span class="pre">curve_data</span></code> <em>dictionary</em> with its <em>pandas</em> <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>s.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># create_hsi_rasters.py</span>
<span class="k">def</span> <span class="nf">get_hsi_curve</span><span class="p">(</span><span class="n">json_file</span><span class="p">,</span> <span class="n">life_stage</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
    <span class="c1"># read the JSON file with fun.read_json</span>
    <span class="n">file_info</span> <span class="o">=</span> <span class="n">read_json</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
    <span class="c1"># instantiate output dictionary</span>
    <span class="n">curve_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># iterate through parameter list (e.g., [&quot;velocity&quot;, &quot;depth&quot;])</span>
    <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
        <span class="c1"># create a void list to store pairs of parameter-HSI values as nested lists</span>
        <span class="n">par_pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># iterate through the length of parameter-HSI curves in the JSON file</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">file_info</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="n">life_stage</span><span class="p">]</span><span class="o">.</span><span class="fm">__len__</span><span class="p">():</span>
            <span class="c1"># if the parameter is not empty (i.e., __len__ &gt; 0), append the parameter-HSI (e.g., [u_value, HSI_value]) pair as nested list</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_info</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="n">life_stage</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;HSI&quot;</span><span class="p">])</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># only append data pairs if both parameter and HSI are numeric (floats)</span>
                    <span class="n">par_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">file_info</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="n">life_stage</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">par_dict</span><span class="p">[</span><span class="n">par</span><span class="p">]]),</span>
                                      <span class="nb">float</span><span class="p">(</span><span class="n">file_info</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="n">life_stage</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;HSI&quot;</span><span class="p">])])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Invalid HSI curve entry for </span><span class="si">{0}</span><span class="s2"> in parameter </span><span class="si">{1}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">life_stage</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>
        <span class="c1"># add the nested parameter pair list as pandas DataFrame to the curve_data dictionary</span>
        <span class="n">curve_data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">par</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">par_pairs</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">par_dict</span><span class="p">[</span><span class="n">par</span><span class="p">],</span> <span class="s2">&quot;HSI&quot;</span><span class="p">])})</span>
    <span class="k">return</span> <span class="n">curve_data</span>
</pre></div>
</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">main</span></code> function, call <code class="docutils literal notranslate"><span class="pre">get_hsi_curves</span></code> to get the <em>HSI</em> curves as a <em>dictionary</em>. In addition, implement the <code class="docutils literal notranslate"><span class="pre">cache</span></code> and the <code class="docutils literal notranslate"><span class="pre">log_actions</span></code> wrappers  (<a class="reference external" href="#funs">recall the descriptions of provided functions</a> for the <code class="docutils literal notranslate"><span class="pre">main</span></code> function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># create_hsi_rasters.py</span>

<span class="o">...</span>

<span class="nd">@log_actions</span>
<span class="nd">@cache</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># get HSI curves as pandas DataFrames nested in a dictionary</span>
    <span class="n">hsi_curve</span> <span class="o">=</span> <span class="n">get_hsi_curve</span><span class="p">(</span><span class="n">fish_file</span><span class="p">,</span> <span class="n">life_stage</span><span class="o">=</span><span class="n">life_stage</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">)</span>

<span class="o">...</span>
</pre></div>
</div>
<p>With the provided <code class="docutils literal notranslate"><span class="pre">HSIRaster</span></code> (<code class="docutils literal notranslate"><span class="pre">raster_hsi.py</span></code>) class, the <em>HSI</em> rasters can be conveniently created in the <code class="docutils literal notranslate"><span class="pre">get_hsi_raster</span></code> function. Before using the <code class="docutils literal notranslate"><span class="pre">HSIRaster</span></code> class, make sure to understand how it works. The <code class="docutils literal notranslate"><span class="pre">HSIRaster</span></code> class inherits from the <code class="docutils literal notranslate"><span class="pre">Raster</span></code> class and initiates its parent class in its <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method through <code class="docutils literal notranslate"><span class="pre">Raster.__init__(self,</span> <span class="pre">file_name=file_name,</span> <span class="pre">band=band,</span> <span class="pre">raster_array=raster_array,</span> <span class="pre">geo_info=geo_info)</span></code>. Then, the class calls its <code class="docutils literal notranslate"><span class="pre">make_hsi</span></code> method, which takes an <em>HSI</em> curve (nested <em>list</em>) of two equal <em>list</em> pairs (<em>list</em> of parameters and <em>list</em> of <em>HSI</em> values) as argument. The <code class="docutils literal notranslate"><span class="pre">make_hsi</span></code> method:</p>
<ul class="simple">
<li><p>Extracts parameter values (e.g., depth or velocity) from the first element of the nested <code class="docutils literal notranslate"><span class="pre">hsi_curves</span></code> <em>list</em>, and <em>HSI</em> values from the second element of the nested <code class="docutils literal notranslate"><span class="pre">hsi_curves</span></code> <em>list</em>.</p></li>
<li><p>Uses <em>numpy</em>’s built-in <code class="docutils literal notranslate"><span class="pre">np.nditer</span></code> function, which iterates through <em>numpy</em> arrays with high computational efficiency (read more about <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.nditer.html"><code class="docutils literal notranslate"><span class="pre">nditer</span></code></a>).</p>
<ul>
<li><p>The <code class="docutils literal notranslate"><span class="pre">nditer</span></code> loop passes the <code class="docutils literal notranslate"><span class="pre">par_values</span></code> as <code class="docutils literal notranslate"><span class="pre">x_values</span></code> <em>list</em> argument and the <code class="docutils literal notranslate"><span class="pre">hsi_values</span></code> as <code class="docutils literal notranslate"><span class="pre">y_values</span></code> <em>list</em> arguments to the <code class="docutils literal notranslate"><span class="pre">interpolate_from_list</span></code> function (<a class="reference external" href="#funs">recall the function descriptions above</a>).</p></li>
<li><p>The array values (i.e., flow velocity or water depth) correspond to the <code class="docutils literal notranslate"><span class="pre">xi_values</span></code> <em>list</em> argument of the <code class="docutils literal notranslate"><span class="pre">interpolate_from_list</span></code> function.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">interpolate_from_list</span></code> function then identifies for each element of the <code class="docutils literal notranslate"><span class="pre">xi_values</span></code> <em>list</em> the closest elements (<em>x<sub>i</sub></em> values) in the <code class="docutils literal notranslate"><span class="pre">x_values</span></code> <em>list</em> and the corresponding positions in the <code class="docutils literal notranslate"><span class="pre">y_values</span></code> <em>list</em>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">interpolate_from_list</span></code> function passes the identified values to the <code class="docutils literal notranslate"><span class="pre">interpolate_y</span></code> function, which then linearly interpolates the corresponding <code class="docutils literal notranslate"><span class="pre">yi</span></code> value (i.e., an <em>HSI</em> value).</p></li>
<li><p>Thus, the flow velocity or water depths in <code class="docutils literal notranslate"><span class="pre">self.array</span></code> are row-wise (row-by-row) replaced by <em>HSI</em> values.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">return</span></code>s a <code class="docutils literal notranslate"><span class="pre">Raster</span></code> instance using the pseudo-private <code class="docutils literal notranslate"><span class="pre">_make_raster</span></code> method (<a class="reference external" href="#make-raster">recall its contents</a>).</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># raster_hsi.py</span>
<span class="kn">from</span> <span class="nn">raster</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">HSIRaster</span><span class="p">(</span><span class="n">Raster</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">hsi_curve</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">raster_array</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">geo_info</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">Raster</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">,</span> <span class="n">raster_array</span><span class="o">=</span><span class="n">raster_array</span><span class="p">,</span> <span class="n">geo_info</span><span class="o">=</span><span class="n">geo_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_hsi</span><span class="p">(</span><span class="n">hsi_curve</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_hsi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hsi_curve</span><span class="p">):</span>
        <span class="n">par_values</span> <span class="o">=</span> <span class="n">hsi_curve</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">hsi_values</span> <span class="o">=</span> <span class="n">hsi_curve</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">nditer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;external_loop&quot;</span><span class="p">],</span> <span class="n">op_flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;readwrite&quot;</span><span class="p">])</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                    <span class="n">x</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolate_from_list</span><span class="p">(</span><span class="n">par_values</span><span class="p">,</span> <span class="n">hsi_values</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: np.array is one-dimensional.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_raster</span><span class="p">(</span><span class="s2">&quot;hsi&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Modify the <code class="docutils literal notranslate"><span class="pre">get_hsi_rasters</span></code> function to directly return a <code class="docutils literal notranslate"><span class="pre">HSIRaster</span></code> object:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># create_hsi_rasters.py</span>

<span class="o">...</span>

<span class="k">def</span> <span class="nf">get_hsi_raster</span><span class="p">(</span><span class="n">tif_dir</span><span class="p">,</span> <span class="n">hsi_curve</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HSIRaster</span><span class="p">(</span><span class="n">tif_dir</span><span class="p">,</span> <span class="n">hsi_curve</span><span class="p">)</span>
<span class="o">...</span>

</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">get_hsi_raster</span></code> function requires two arguments, which it must receive from the <code class="docutils literal notranslate"><span class="pre">main</span></code> function. For this reason, iterate over the <code class="docutils literal notranslate"><span class="pre">parameters</span></code> <em>list</em> in the <code class="docutils literal notranslate"><span class="pre">main</span></code> function and extract the corresponding raster directories from the <code class="docutils literal notranslate"><span class="pre">tifs</span></code> <em>dictionary</em> (recall the variable definition in the <a class="reference external" href="#chsi-template">standalone statement</a>). In addition, save the <code class="docutils literal notranslate"><span class="pre">Raster</span></code> objects returned by the <code class="docutils literal notranslate"><span class="pre">get_hsi_raster</span></code> function in another <em>dictionary</em> (<code class="docutils literal notranslate"><span class="pre">eco_rasters</span></code>) to combine them in the next step into a <em>cHSI</em> raster.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># create_hsi_rasters.py</span>

<span class="o">...</span>

<span class="nd">@log_actions</span>
<span class="nd">@cache</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># get HSI curves as pandas DataFrames nested in a dictionary</span>
    <span class="n">hsi_curve</span> <span class="o">=</span> <span class="n">get_hsi_curve</span><span class="p">(</span><span class="n">fish_file</span><span class="p">,</span> <span class="n">life_stage</span><span class="o">=</span><span class="n">life_stage</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">)</span>

        <span class="c1"># create HSI rasters for all parameters considered and store the Raster objects in a dictionary</span>
    <span class="n">eco_rasters</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
        <span class="n">hsi_par_curve</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">hsi_curve</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="n">par_dict</span><span class="p">[</span><span class="n">par</span><span class="p">]]),</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">hsi_curve</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="s2">&quot;HSI&quot;</span><span class="p">])]</span>
        <span class="n">eco_rasters</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">par</span><span class="p">:</span> <span class="n">get_hsi_raster</span><span class="p">(</span><span class="n">tif_dir</span><span class="o">=</span><span class="n">tifs</span><span class="p">[</span><span class="n">par</span><span class="p">],</span> <span class="n">hsi_curve</span><span class="o">=</span><span class="n">hsi_par_curve</span><span class="p">)})</span>
        <span class="n">eco_rasters</span><span class="p">[</span><span class="n">par</span><span class="p">]</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">hsi_output_dir</span> <span class="o">+</span> <span class="s2">&quot;hsi_</span><span class="si">%s</span><span class="s2">.tif&quot;</span> <span class="o">%</span> <span class="n">par</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Of course, one can also loop over the parameters <em>list</em> directly in the <code class="docutils literal notranslate"><span class="pre">get_hsi_raster</span></code> function.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>This is a good moment to test if the code works. Run <code class="docutils literal notranslate"><span class="pre">create_hsi_rasters.py</span></code> and verify that the two <em>GeoTIFF</em> files (<em>habitat/hsi_velocity.tif</em> and <em>/habitat/hsi_depth.tif</em>) are created correctly. <em>QGIS</em> visualizes the <em>GeoTIFF</em>-products and the activated <em>Identify Features</em> button in <em>QGIS</em> enables to check if the linearly interpolated <em>HSI</em> values agree with the <em>HSI</em> curves in the provided workbook (<em>/habitat/trout.xlsx</em>). Thus, load both <em>GeoTIFF</em> pairs in <em>QGIS</em>: <em>/habitat/hsi_velocity.tif</em> + <em>/basement/flow_velocity.tif</em> and <em>/habitat/hsi_depth.tif</em>  + <em>/basement/water_depth.tif</em>.</p>
</div>
<p>Next, we come to the reason why we had to define magic methods for the <code class="docutils literal notranslate"><span class="pre">Raster</span></code> class: combine the <em>HSI</em> rasters using both combination formulae presented above (recall the <a class="reference external" href="#combine-methods">product and geometric mean</a> formulae), where <code class="docutils literal notranslate"><span class="pre">&quot;geometric_mean&quot;</span></code> should be used by default. The <code class="docutils literal notranslate"><span class="pre">combine_hsi_rasters</span></code> function accepts two arguments (a <em>list</em> of <code class="docutils literal notranslate"><span class="pre">Raster</span></code> objects corresponding to <em>HSI</em> rasters and the <code class="docutils literal notranslate"><span class="pre">method</span></code> to use as <em>string</em>).</p>
<p>If the method corresponds to the default value <code class="docutils literal notranslate"><span class="pre">&quot;geometric_mean&quot;</span></code>, then the <code class="docutils literal notranslate"><span class="pre">power</span></code> to be applied to the product of the <code class="docutils literal notranslate"><span class="pre">Raster</span></code> <em>list</em> is calculated from the <em>n</em>th root, where <em>n</em> corresponds to the number of <code class="docutils literal notranslate"><span class="pre">Raster</span></code> objects in the <code class="docutils literal notranslate"><span class="pre">raster_list</span></code>. Otherwise (e.g., <code class="docutils literal notranslate"><span class="pre">method=&quot;product&quot;</span></code>), the <code class="docutils literal notranslate"><span class="pre">power</span></code> is exactly 1.0.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">combine_hsi_rasters</span></code> function initially creates an empty <em>cHSI</em> <code class="docutils literal notranslate"><span class="pre">Raster</span></code> in the <code class="docutils literal notranslate"><span class="pre">cache_folder</span></code>, with each cell having the value <code class="docutils literal notranslate"><span class="pre">1.0</span></code> (filled through <code class="docutils literal notranslate"><span class="pre">np.ones</span></code>). In a loop over the <code class="docutils literal notranslate"><span class="pre">Raster</span></code> elements of the <code class="docutils literal notranslate"><span class="pre">raster_list</span></code>, the function multiplies each <em>HSI</em> raster with the <em>cHSI</em> raster.</p>
<p>Finally, the function returns the product of all <em>HSI</em> rasters to the power of the previously determined <code class="docutils literal notranslate"><span class="pre">power</span></code> value.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># create_hsi_rasters.py</span>
<span class="k">def</span> <span class="nf">combine_hsi_rasters</span><span class="p">(</span><span class="n">raster_list</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;geometric_mean&quot;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="s2">&quot;geometric_mean&quot;</span><span class="p">:</span>
        <span class="n">power</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">raster_list</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># supposedly method is &quot;product&quot;</span>
        <span class="n">power</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="n">chsi_raster</span> <span class="o">=</span> <span class="n">Raster</span><span class="p">(</span><span class="n">cache_folder</span> <span class="o">+</span> <span class="s2">&quot;chsi_start.tif&quot;</span><span class="p">,</span>
                         <span class="n">raster_array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">raster_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
                         <span class="n">epsg</span><span class="o">=</span><span class="n">raster_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">epsg</span><span class="p">,</span>
                         <span class="n">geo_info</span><span class="o">=</span><span class="n">raster_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">geo_transformation</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ras</span> <span class="ow">in</span> <span class="n">raster_list</span><span class="p">:</span>
        <span class="n">chsi_raster</span> <span class="o">=</span> <span class="n">chsi_raster</span> <span class="o">*</span> <span class="n">ras</span>

    <span class="k">return</span> <span class="n">chsi_raster</span> <span class="o">**</span> <span class="n">power</span>
</pre></div>
</div>
<p>To finish the <code class="docutils literal notranslate"><span class="pre">create_hsi_rasters.py</span></code> script, implement the call to the <code class="docutils literal notranslate"><span class="pre">combine_hsi_rasters</span></code> function in the <code class="docutils literal notranslate"><span class="pre">main</span></code> function and save the result as <em>cHSI</em> <em>GeoTIFF</em> raster in the <code class="docutils literal notranslate"><span class="pre">/habitat/</span></code> folder:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># create_hsi_rasters.py</span>

<span class="o">...</span>

<span class="nd">@log_actions</span>
<span class="nd">@cache</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="o">...</span>

    <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
        <span class="n">hsi_par_curve</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">hsi_curve</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="n">par_dict</span><span class="p">[</span><span class="n">par</span><span class="p">]]),</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">hsi_curve</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="s2">&quot;HSI&quot;</span><span class="p">])]</span>
        <span class="n">eco_rasters</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">par</span><span class="p">:</span> <span class="n">get_hsi_raster</span><span class="p">(</span><span class="n">tif_dir</span><span class="o">=</span><span class="n">tifs</span><span class="p">[</span><span class="n">par</span><span class="p">],</span> <span class="n">hsi_curve</span><span class="o">=</span><span class="n">hsi_par_curve</span><span class="p">)})</span>
        <span class="n">eco_rasters</span><span class="p">[</span><span class="n">par</span><span class="p">]</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">hsi_output_dir</span> <span class="o">+</span> <span class="s2">&quot;hsi_</span><span class="si">%s</span><span class="s2">.tif&quot;</span> <span class="o">%</span> <span class="n">par</span><span class="p">)</span>

    <span class="c1"># get and save chsi raster</span>
    <span class="n">chsi_raster</span> <span class="o">=</span> <span class="n">combine_hsi_rasters</span><span class="p">(</span><span class="n">raster_list</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">eco_rasters</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
                                      <span class="n">method</span><span class="o">=</span><span class="s2">&quot;geometric_mean&quot;</span><span class="p">)</span>
    <span class="n">chsi_raster</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">hsi_output_dir</span> <span class="o">+</span> <span class="s2">&quot;chsi.tif&quot;</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="run-the-hsi-and-chsi-raster-creation-code">
<h3>Run the <em>HSI</em> and <em>cHSI</em> raster creation code<a class="headerlink" href="#run-the-hsi-and-chsi-raster-creation-code" title="Permalink to this headline">¶</a></h3>
<p>A successful run of the script <code class="docutils literal notranslate"><span class="pre">create_hsi_rasters.py</span></code> should look like this (in <em>PyCharm</em>):</p>
<p><img alt="run-chsi" src="https://github.com/Ecohydraulics/Exercise-geco/raw/master/graphs/run_create_chsi_rasters.png" /><br></p>
<p>Plotted in <em>QGIS</em>, the <em>cHSI</em> <em>GeoTIFF</em> raster should look like this:</p>
<p><img alt="chsi-results" src="https://github.com/Ecohydraulics/Exercise-geco/raw/master/graphs/ex-chsi.png" /><br>
<em>The cHSI raster plotted in QGIS, where poor physical habitat quality (cHSI close to 0.0) is colored in red and high physical habitat quality (cHSI close to 1.0) is colored in green.</em></p>
</div>
<div class="section" id="result-interpretation">
<h3>Result interpretation<a class="headerlink" href="#result-interpretation" title="Permalink to this headline">¶</a></h3>
<p>The presentation of the <em>cHSI</em> raster shows that preferred habitat areas for juvenile trout exist only close to the banks. Also, numerical artifacts of the triangular mesh used by <em>BASEMENT</em> are visible. Therefore, the question arises whether the calculated flow velocities and water depths, and in consequence also the <em>cHSI</em> values, close to the banks can be considered representative.</p>
</div>
</div>
<div class="section" id="calculate-the-usable-habitat-area">
<h2>Calculate the usable habitat area<a class="headerlink" href="#calculate-the-usable-habitat-area" title="Permalink to this headline">¶</a></h2>
<div class="section" id="write-the-code">
<h3>Write the code<a class="headerlink" href="#write-the-code" title="Permalink to this headline">¶</a></h3>
<p>The <em>cHSI</em> rasters enable the calculation of the available usable habitat area. The previous section featured examples using the fish species <em>trout</em> and its <em>juvenile</em> life stage, for which we will determine here the usable habitat area <em>UHA</em> (in m²) using a <em>cHSI</em> threshold value (rather than the pixel area weighting approach). So we follow the <a class="reference external" href="#uha-methods">threshold formula described above</a>, using a threshold value of <em>cHSI<sub>crit</sub></em> = 0.4. Thus, every pixel that has a <em>cHSI</em> value of 0.4 or greater counts as usable habitat area.</p>
<p>From a technical point of view, this part of the exercise is about converting a raster into a polygon shapefile as well as accessing and modifying the <em>Attribute Table</em> of the shapefile.</p>
<p>Similar to the creation of the <em>cHSI</em> raster, there is a template script available for this part of the exercise, called <code class="docutils literal notranslate"><span class="pre">calculate_habitat_area.py</span></code>, which contains package and module imports, an <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">__name__</span> <span class="pre">==</span> <span class="pre">'__main__'</span></code> stand-alone statement, as well as the void <code class="docutils literal notranslate"><span class="pre">main</span></code> and <code class="docutils literal notranslate"><span class="pre">calculate_habitat_area</span></code> functions. The template script looks like this:<a name="uha-template"></a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># this is calculate_habitat_area.py (template)</span>
<span class="kn">from</span> <span class="nn">fun</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">raster</span> <span class="kn">import</span> <span class="n">Raster</span>


<span class="k">def</span> <span class="nf">calculate_habitat_area</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">epsg</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">pass</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">chsi_raster_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">habitat</span><span class="se">\\</span><span class="s2">chsi.tif&quot;</span>
    <span class="n">chsi_threshold</span> <span class="o">=</span> <span class="mf">0.4</span>

    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">__name__</span> <span class="pre">==</span> <span class="pre">'__main__'</span></code> statement, make sure that the global variable <code class="docutils literal notranslate"><span class="pre">chsi_raster_name</span></code> corresponds to the directory of the <em>cHSI</em> raster created in the previous section. The other global variable (<code class="docutils literal notranslate"><span class="pre">chsi_threshold</span></code>) corresponds to the <em>cHSI<sub>crit</sub></em> value of 0.4 that we will use with the <a class="reference external" href="#uha-methods">threshold formula</a>.</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">main</span></code> function, start with loading the <em>cHSI</em> raster (<code class="docutils literal notranslate"><span class="pre">chsi_raster</span></code>) as a <a class="reference external" href="#raster"><code class="docutils literal notranslate"><span class="pre">Raster</span></code> object</a>. Then, access the <em>numpy</em> array of the <em>cHSI</em> raster and compare it with <code class="docutils literal notranslate"><span class="pre">chsi_threshold</span></code> using <em>numpy</em>’s built-in <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.greater_equal.html"><em>greater_equal</em></a> function. <code class="docutils literal notranslate"><span class="pre">np.greater_equal</span></code> takes an array as first argument and a second argument, which is the condition that can be a numeric variable or another <em>numpy</em> array. Then, <code class="docutils literal notranslate"><span class="pre">np.greater_equal</span></code> checks if the elements of the first array are greater than or equal to the second argument. In the case of the second argument being an array, this is an element-wise ≥ comparison. The result of <code class="docutils literal notranslate"><span class="pre">np.greater_equal</span></code> is a <em>boolean</em> array (<code class="docutils literal notranslate"><span class="pre">True</span></code> where the greater-or-equal condition is fulfilled and <code class="docutils literal notranslate"><span class="pre">False</span></code> otherwise). However, to create an <code class="docutils literal notranslate"><span class="pre">osgeo.gdal.Dataset</span></code> object from the result of <code class="docutils literal notranslate"><span class="pre">np.greater_equal</span></code>, we need a numeric array. For this reason, multiply the result of <code class="docutils literal notranslate"><span class="pre">np.greater_equal</span></code> by 1.0 and assign it as a new <em>numpy</em> array of zeros (<code class="docutils literal notranslate"><span class="pre">False</span></code>) and ones (<code class="docutils literal notranslate"><span class="pre">True</span></code>) to a variable named <code class="docutils literal notranslate"><span class="pre">habitat_pixels</span></code> (see the code block below).</p>
<p>With the <code class="docutils literal notranslate"><span class="pre">habitat_pixels</span></code> array and the georeference of <code class="docutils literal notranslate"><span class="pre">chsi_raster</span></code>, create a new <em>integer</em> <em>GeoTIFF</em> raster with the <a class="reference external" href="https://github.com/hydro-informatics/geo-utils#create-raster"><em>create_raster</em> function of <em>geo_utils</em></a> (here: <code class="docutils literal notranslate"><span class="pre">geo.create_raster</span></code>). In the following code block the new raster is saved in the <em>/habitat/</em> folder of the exercise as <code class="docutils literal notranslate"><span class="pre">habitat-pixels.tif</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculate_habitat_area.py</span>
<span class="o">...</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># open the chsi raster</span>
    <span class="n">chsi_raster</span> <span class="o">=</span> <span class="n">Raster</span><span class="p">(</span><span class="n">chsi_ras_name</span><span class="p">)</span>
    <span class="c1"># extract pixels where the physical habitat quality is higher than the user threshold value</span>
    <span class="n">habitat_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">greater_equal</span><span class="p">(</span><span class="n">chsi_raster</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">chsi_threshold_value</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span>
    <span class="c1"># write the habitat pixels to a binary array (0 -&gt; no habitat, 1 -&gt; usable habitat)</span>
    <span class="n">geo</span><span class="o">.</span><span class="n">create_raster</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">habitat</span><span class="se">\\</span><span class="s2">habitat-pixels.tif&quot;</span><span class="p">,</span>
                      <span class="n">raster_array</span><span class="o">=</span><span class="n">habitat_pixels</span><span class="p">,</span>
                      <span class="n">epsg</span><span class="o">=</span><span class="n">chsi_raster</span><span class="o">.</span><span class="n">epsg</span><span class="p">,</span>
                      <span class="n">geo_info</span><span class="o">=</span><span class="n">chsi_raster</span><span class="o">.</span><span class="n">geo_transformation</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
<p>In the next step, convert the habitat pixel raster into a polygon shapefile and save it in the <em>/habitat/</em> folder as <code class="docutils literal notranslate"><span class="pre">habitat-area.shp</span></code>. The conversion of a raster into a polygon shapefile requires that the raster contains only <em>integer</em> values, which is the case in the habitat pixel raster (only zeros and ones - <a class="reference external" href="geopy/geo-convert.html#raster2polygon">recall the lecture notes</a>). With the <a class="reference external" href="https://github.com/hydro-informatics/geo-utils#convert-raster-to-polygon-shapefile"><em>raster2polygon</em> function of <em>geo_utils</em></a>, create the new polygon shapefile, specify <em>habitat-pixels.tif</em> as <code class="docutils literal notranslate"><span class="pre">raster_file_name</span></code> to be converted, and <code class="docutils literal notranslate"><span class="pre">/habitat/habitat-area.shp</span></code> as output file name.
<code class="docutils literal notranslate"><span class="pre">geo.raster2polygon</span></code> returns an <code class="docutils literal notranslate"><span class="pre">osgeo.ogr.DataSource</span></code> object and we can pass its layer including the information of the <em>EPSG</em> authority code (from <code class="docutils literal notranslate"><span class="pre">chsi_raster</span></code>) directly to the not-yet-written <code class="docutils literal notranslate"><span class="pre">calculate_habitat_area</span></code> function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculate_habitat_area.py</span>
<span class="o">...</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="o">...</span> <span class="p">(</span><span class="n">create</span> <span class="n">habitat</span> <span class="n">pixels</span> <span class="n">raster</span><span class="p">)</span>

    <span class="c1"># convert the raster with usable pixels to polygon (must be an integer raster!)</span>
    <span class="n">tar_shp_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">habitat</span><span class="se">\\</span><span class="s2">habitat-area.shp&quot;</span>
    <span class="n">habitat_polygons</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">raster2polygon</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">habitat</span><span class="se">\\</span><span class="s2">habitat-pixels.tif&quot;</span><span class="p">,</span>
                                          <span class="n">tar_shp_file_name</span><span class="p">)</span>

    <span class="c1"># calculate the habitat area (will be written to the attribute table)</span>
    <span class="n">calculate_habitat_area</span><span class="p">(</span><span class="n">habitat_polygons</span><span class="o">.</span><span class="n">GetLayer</span><span class="p">(),</span> <span class="n">chsi_raster</span><span class="o">.</span><span class="n">epsg</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
<p>In order for the <code class="docutils literal notranslate"><span class="pre">calculate_habitat_area</span></code> function to produce what its name promises, we need to populate this function as well. For this purpose, use the <code class="docutils literal notranslate"><span class="pre">epsg</span></code> <em>integer</em> argument to identify the unit system of the shapefile.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculate_habitat_area.py</span>
<span class="o">...</span>

<span class="k">def</span> <span class="nf">calculate_habitat_area</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">epsg</span><span class="p">):</span>
    <span class="c1"># retrieve units</span>
    <span class="n">srs</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
    <span class="n">srs</span><span class="o">.</span><span class="n">ImportFromEPSG</span><span class="p">(</span><span class="n">epsg</span><span class="p">)</span>
    <span class="n">area_unit</span> <span class="o">=</span> <span class="s2">&quot;square </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">srs</span><span class="o">.</span><span class="n">GetLinearUnitsName</span><span class="p">()</span>
<span class="o">...</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In practice, many mistakes are made due to the incorrect use of area units, which is often not obvious at first because of the size of geospatial data (several gigabytes). There are many units of length and area (meters, feet, acre, hectare, km²) and a difference of an order of magnitude is sometimes only noticed when a critical reviewer or a local expert becomes suspicious. In the application shown here, we use the information of the length units only to output the total area with a correct reference to the area units (m²) on the console, but in practice, this information can save a career.</p>
</div>
<p>To determine the habitat area, the area of each polygon must be calculated. For this purpose, add a new field to the <code class="docutils literal notranslate"><span class="pre">layer</span></code> in the <em>Attribute Table</em>, name it <code class="docutils literal notranslate"><span class="pre">&quot;area&quot;</span></code>, and assign a <code class="docutils literal notranslate"><span class="pre">geo.ogr.OFTReal</span></code> (numeric) data type (recall how to <a class="reference external" href="geopy/geo-shp.html#add-field">create a field an data types explained in the lecture notes</a>).
Then, create a void <em>list</em> called <code class="docutils literal notranslate"><span class="pre">poly_size</span></code>, in which we will write the area of all polygons that have a field value of <code class="docutils literal notranslate"><span class="pre">1</span></code>. To access the individual polygons (features) of the <code class="docutils literal notranslate"><span class="pre">layer</span></code>, iterate through all features using a <code class="docutils literal notranslate"><span class="pre">for</span></code> loop, which:</p>
<ul class="simple">
<li><p>Extracts the polygon of every <code class="docutils literal notranslate"><span class="pre">feature</span></code> using <code class="docutils literal notranslate"><span class="pre">polygon</span> <span class="pre">=</span> <span class="pre">feature.GetGeometryRef()</span></code></p></li>
<li><p>Appends the polygon’s area size to the <code class="docutils literal notranslate"><span class="pre">poly_size</span></code> <em>list</em> if the field <code class="docutils literal notranslate"><span class="pre">&quot;value&quot;</span></code> of the <code class="docutils literal notranslate"><span class="pre">polygon</span></code> (at position 0: <code class="docutils literal notranslate"><span class="pre">feature.GetField(0)</span></code>) is 1 (<code class="docutils literal notranslate"><span class="pre">True</span></code>).</p></li>
<li><p>Writes the polygon’s area size to the <em>Attribute Table</em>  with <code class="docutils literal notranslate"><span class="pre">feature.SetField(&quot;area&quot;,</span> <span class="pre">polygon.GetArea()</span></code>.</p></li>
<li><p>Saves the changes (calculated area) to the shapefile <code class="docutils literal notranslate"><span class="pre">layer</span></code> with <code class="docutils literal notranslate"><span class="pre">layer.SetFeature(feature)</span></code>.</p></li>
</ul>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Looping through an attribute table is computationally expensive in <em>Python</em>. If a shapefile has many elements (points, lines, polygons), this loop can last for hours, days, or even weeks. Therefore, it can be useful to convert a shapefile into a raster and perform calculations using <em>numpy</em>’s computationally efficient built-in functions (C/C++ wrappers), which are many times faster. A particular problem is the processing of large lidar datasets (several million points), where it may be necessary to use other software (read more at <a class="reference external" href="https://www.earthdatascience.org/courses/use-data-open-source-python/data-stories/what-is-lidar-data/explore-lidar-point-clouds-plasio/">earthdatascience.org</a>).</p>
</div>
<p>The last information needed after the <code class="docutils literal notranslate"><span class="pre">for</span></code> loop is the total area of the <code class="docutils literal notranslate"><span class="pre">&quot;value&quot;=1</span></code> polygons, which we get by writing the <code class="docutils literal notranslate"><span class="pre">sum</span></code> of the <code class="docutils literal notranslate"><span class="pre">poly_size</span></code> <em>list</em> to the console. Therefore, the second and last part of the <code class="docutils literal notranslate"><span class="pre">calculate_habitat_area</span></code> function looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculate_habitat_area.py</span>
<span class="o">...</span>
<span class="k">def</span> <span class="nf">calculate_habitat_area</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">epsg</span><span class="p">):</span>

    <span class="o">...</span> <span class="p">(</span><span class="n">extract</span> <span class="n">unit</span> <span class="n">system</span> <span class="n">information</span><span class="p">)</span>

    <span class="c1"># add area field</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">CreateField</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">ogr</span><span class="o">.</span><span class="n">FieldDefn</span><span class="p">(</span><span class="s2">&quot;area&quot;</span><span class="p">,</span> <span class="n">geo</span><span class="o">.</span><span class="n">ogr</span><span class="o">.</span><span class="n">OFTReal</span><span class="p">)</span>

    <span class="c1"># create list to store polygon sizes</span>
    <span class="n">poly_size</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># iterate through geometries (polygon features) of the layer</span>
    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">layer</span><span class="p">:</span>
        <span class="c1"># retrieve polygon geometry</span>
        <span class="n">polygon</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">GetGeometryRef</span><span class="p">()</span>
        <span class="c1"># add polygon size if field &quot;value&quot; is one (determined by chsi_treshold)</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">GetField</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">poly_size</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">polygon</span><span class="o">.</span><span class="n">GetArea</span><span class="p">()</span>
        <span class="c1"># write area to area field</span>
        <span class="n">feature</span><span class="o">.</span><span class="n">SetField</span><span class="p">(</span><span class="s2">&quot;area&quot;</span><span class="p">,</span> <span class="n">polygon</span><span class="o">.</span><span class="n">GetArea</span><span class="p">()</span>
        <span class="c1"># add the feature modifications to the layer</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">SetFeature</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

    <span class="c1"># calculate and print habitat area</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The total habitat area is </span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">poly_size</span><span class="p">),</span> <span class="n">area_unit</span><span class="p">)</span>

<span class="o">...</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To calculate other geometry attributes than the polygon area (e.g., envelope extents, derive a convex hull, or get the length of lines), refer to the <a class="reference external" href="geopy/geo-shp.html#calc">functions described in the lecture notes</a> and use those functions in lieu of <code class="docutils literal notranslate"><span class="pre">polygon.GetArea()</span></code>.</p>
</div>
</div>
<div class="section" id="run-the-usable-habitat-area-calculation-code">
<h3>Run the Usable Habitat Area calculation code<a class="headerlink" href="#run-the-usable-habitat-area-calculation-code" title="Permalink to this headline">¶</a></h3>
<p>A successful run of the script <code class="docutils literal notranslate"><span class="pre">calculate_habitat_area.py</span></code> should look like this (in <em>PyCharm</em>):
<img alt="run-chsi" src="https://github.com/Ecohydraulics/Exercise-geco/raw/master/graphs/run_habitat_area.png" /> <br></p>
<p>Plotted in <em>QGIS</em>, the <em>habitat-area</em> shapefile looks like this (use <em>Categorized</em> symbology):</p>
<p><img alt="uha-results" src="https://github.com/Ecohydraulics/Exercise-geco/raw/master/graphs/ex-uha.png" /> <br>
<em>The habitat-area shapefile plotted in QGIS with Categorized symbology, where the usable habitat area UHA (cHSI &gt; 0.4) is delineated by the hatched purple patches and their dashed outlines.</em></p>
</div>
<div class="section" id="id1">
<h3>Result interpretation<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>The <em>UHA</em> of the analyzed river section represents a very small share of the total wetted area, which can be interpreted as an ecologically poor status of the river. However, a glance at a map and the simulation files of the Flaz example of <em>BASEMENT</em> suggests that at a discharge of 50 m³/s, a flood situation can be assumed. As during floods, there are generally higher flow velocities, which are out-of-favor of juvenile fish, the small usable habitat area is finally not surprising.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Remember that the here presented habitat assessment assumes that fish prefer regions with high <em>cHSI</em> values and that rivers with a high proportion of areas with high <em>cHSI</em> values are ecologically particularly valuable. This approach represents an assessment of the physical habitat state with limited information on the functional habitat state.</p>
</div>
<div class="admonition-homework admonition">
<p class="admonition-title">Homework</p>
<p>Rewrite the magic methods of the <code class="docutils literal notranslate"><span class="pre">Raster</span></code> class by using <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">__METHOD__(self,</span> <span class="pre">other:</span> <span class="pre">Raster)</span> <span class="pre">-&gt;</span> <span class="pre">Raster:</span></code> instead of <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">__METHOD__(self,</span> <span class="pre">constant_or_raster):</span></code> and the <code class="docutils literal notranslate"><span class="pre">_make_raster</span></code> method.</p>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "hydro-informatics/hydro-informatics.github.io",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./exercises"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="geo-exercises.html" title="previous page">Exercises</a>
    <a class='right-next' id="next-link" href="../numerics/numerical-modeling.html" title="next page">Principles</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Sebastian Schwindt<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../_static/js/index.d3f166471bb80abb5163.js"></script>


    
  </body>
</html>